<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/app-layout/app-layout.html">
<link rel="import" href="/bower_components/iron-icons/image-icons.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../tikkun-page/tikkun-page.html">

<dom-module id="tikkun-book">
    <template>
        <style>
            @font-face {
                font-family: "ShlomosemiStam";
                src: url(/assets/fonts/ShlomosemiStam.ttf);
            }

            app-toolbar {
                background-color: slategray;
                box-shadow: 0 8px 8px -8px hsla(0, 0%, 0%, 0.5);
                color: hsla(0, 0%, 0%, 0.7);
                display: flex;
                justify-content: space-between;
            }

            .navigation {
                display: flex;
                align-items: center;
            }

                .navigation-controls {
                    display: flex;
                    margin-left: 1em;
                }

                .navigation-title {
                    color: hsla(0, 0%, 100%, 0.8);
                    font-size: 1.25em;
                }

            app-toolbar paper-icon-button {
                --paper-icon-button: {
                    background-color: hsla(0, 0%, 100%, 0.8);
                    border-radius: 50%;
                };

                margin-left: 0.25em;
            }

            .paper-labeled-toggle-button {
                display: flex;
                font-family: ShlomosemiStam;
                background-color: hsla(0, 0%, 100%, 0.8);
                border-radius: 4px;
                padding: 0.3em 0.5em;
                direction: ltr;
            }

            .paper-labeled-toggle-button::before {
                content: attr(data-off);
                display: inline-block;
                margin-right: 0.5em;
            }

            .paper-labeled-toggle-button::after {
                content: attr(data-on);
                display: inline-block;
            }

            .paper-labeled-toggle-button > * {
                margin-right: 0.5em;
            }

            tikkun-page {
                background-color: white;
                padding: 4em 0;
                margin: 1em;
                /*margin: 1em 1em 4em;*/
                border-radius: 4px;
                box-shadow: 0 0 8px hsla(0, 0%, 0%, 0.5);
            }
        </style>

        <iron-ajax url="/build/page-titles.json" last-response="{{pageTitles}}" auto></iron-ajax>

        <app-header-layout>
            <app-header fixed>
                <app-toolbar>
                    <div class="navigation">
                        <div class="navigation-controls">
                            <paper-icon-button id="prev-button" icon="image:navigate-next" on-click="prev"></paper-icon-button>
                            <paper-icon-button id="next-button" icon="image:navigate-before" on-click="next"></paper-icon-button>
                        </div>
                        <div class="navigation-title">
                            {{parshaDisplay(pageTitles, currentPage)}}
                        </div>
                    </div>
                    <div class="actions">
                        <div class="paper-labeled-toggle-button" data-off="א" data-on="אֶ֨">
                            <paper-toggle-button checked="{{annotated}}"></paper-toggle-button>
                        </div>
                    </div>
                </app-toolbar>
            </app-header>
            <tikkun-page page-number="{{currentPage}}" annotated="[[annotated]]"></tikkun-page>
        </app-header-layout>

    </template>

    <script>

        Polymer({
            is: 'tikkun-book',

            properties: {
                annotated: {
                    type: Boolean,
                    value: false
                },

                currentPage: {
                    type: Number,
                    value: 1
                },

                firstPage: {
                    type: Number,
                    value: 1
                },

                lastPage: {
                    type: Number,
                    value: 1
                }
            },

            ready: function () {

                var keyMap = {
                    32: 'SPACE',
                    37: 'LEFT',
                    39: 'RIGHT',
                    190: 'PERIOD'
                };

                var previousKeyDirections = {
                    annotationsToggle: 'up'
                };

                var keyActions = {
                    PERIOD: function (self, keyDirection) {
                        if (keyDirection !== previousKeyDirections.annotationsToggle) {

                            self.annotated = !self.annotated;

                            previousKeyDirections.annotationsToggle = keyDirection;
                        }

                    },
                    LEFT: function (self, keyDirection) {
                        if (keyDirection === 'down') {
                            self.next();
                        }
                    },
                    RIGHT: function (self, keyDirection) {
                        if (keyDirection === 'down') {
                            self.prev();
                        }
                    },
                }

                var that = this;

                window.addEventListener('keydown', function (e) {

                    var key = keyMap[e.keyCode];

                    if (key) {
                        keyActions[key](that, 'down');
                    }
                });

                window.addEventListener('keyup', function (e) {

                    var key = keyMap[e.keyCode]

                    if (key) {
                        keyActions[key](that, 'up');
                    }
                });
            },

            next: function () {
                this.jumpTo(this.currentPage + 1);
            },

            prev: function () {
                this.jumpTo(Math.max(this.currentPage - 1, 1));
            },

            jumpTo: function (pageNumber) {

                this.currentPage = pageNumber;

                this.$['scroll-view'].scrollTop = 0;
            },

            parshaDisplay: function (pageTitles, currentPage) {
                return pageTitles[currentPage - 1].join(' – ');
            }
        });
    </script>
</dom-module>
